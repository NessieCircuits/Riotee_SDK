#ifndef __RIOTEE_AM1805_H_
#define __RIOTEE_AM1805_H_

#include <stdint.h>
#include <time.h>

#define AM1805_I2C_ADDR 0x69

#define AM1805_HUNDRETH_REG 0x00
#define AM1805_SECOND_REG 0x01
#define AM1805_MINUTE_REG 0x02
#define AM1805_HOUR_REG 0x03
#define AM1805_DATE_REG 0x04
#define AM1805_MONTH_REG 0x05
#define AM1805_YEAR_REG 0x06
#define AM1805_WEEKDAY_REG 0x07
#define AM1805_HUNDRETH_ALARM_REG 0x08
#define AM1805_SECOND_ALARM_REG 0x09
#define AM1805_MINUTE_ALARM_REG 0x0A
#define AM1805_HOUR_ALARM_REG 0x0B
#define AM1805_DATE_ALARM_REG 0x0C
#define AM1805_MONTH_ALARM_REG 0x0D
#define AM1805_WEEKDAY_ALARM_REG 0x0E
#define AM1805_STATUS_REG 0x0F
#define AM1805_CONTROL1_REG 0x10
#define AM1805_CONTROL2_REG 0x11
#define AM1805_INT_MSK_REG 0x12
#define AM1805_SQW_REG 0x13
#define AM1805_CAL_XT_REG 0x14
#define AM1805_CAL_RC_HI_REG 0x15
#define AM1805_CAL_RC_LOW_REG 0x16
#define AM1805_SLEEP_CONTROL_REG 0x17
#define AM1805_TIMER_CONTROL_REG 0x18
#define AM1805_TIMER_REG 0x19
#define AM1805_TIMER_INITIAL_REG 0x1A
#define AM1805_WDT_REG 0x1B
#define AM1805_OSC_CONTROL_REG 0x1C
#define AM1805_OSC_STATUS_REG 0x1D
#define AM1805_CONFIG_KEY_REG 0x1F
#define AM1805_TRICKLE_REG 0x20
#define AM1805_BREF_CONTROL_REG 0x21
#define AM1805_AFCTRL_REG 0x26
#define AM1805_BATMODE_REG 0x27
#define AM1805_ID0_REG 0x28
#define AM1805_ID1_REG 0x29
#define AM1805_ID2_REG 0x2A
#define AM1805_ID3_REG 0x2B
#define AM1805_ID4_REG 0x2C
#define AM1805_ID5_REG 0x2D
#define AM1805_ID6_REG 0x2E
#define AM1805_ASTAT_REG 0X2F
#define AM1805_OCTRL_REG 0x30
#define AM1805_XTENSION_ADDR_REG 0x3F

#define AM1805_TENTH_MSK 0xF0
#define AM1805_HUNDRETH_MSK 0x0F
#define AM1805_SECOND_MSK 0x7F
#define AM1805_MINUTE_MSK 0x7F
#define AM1805_HOUR_24_MSK 0x3F
#define AM1805_HOUR_12_MSK 0x1F
#define AM1805_AM_PM_MSK 0x20
#define AM1805_DATE_MSK 0x3F
#define AM1805_MONTH_MSK 0x1F
#define AM1805_YEAR_MSK 0xFF
#define AM1805_DAY_MSK 0x07

#define AM1805_TENTH_ALARM_MSK 0xF0
#define AM1805_HUNDRETH_ALARM_MSK 0xF0
#define AM1805_SECOND_ALARM_MSK 0x7F
#define AM1805_MINUTE_ALARM_MSK 0x7F
#define AM1805_HOUR_24_ALARM_MSK 0x3F
#define AM1805_HOUR_12_ALARM_MSK 0x1F
#define AM1805_DATE_ALARM_MSK 0x3F
#define AM1805_MONTH_ALARM_MSK 0x1F
#define AM1805_WEEKDAY_ALARM_MSK 0x07

#define AM1805_STATUS_CB_MSK 0x80
#define AM1805_STATUS_BAT_MSK 0x40
#define AM1805_STATUS_WDT_MSK 0x20
#define AM1805_STATUS_BL_MSK 0x10
#define AM1805_STATUS_TIM_MSK 0x08
#define AM1805_STATUS_ALM_MSK 0x04
#define AM1805_STATUS_EX2_MSK 0x02
#define AM1805_STATUS_EX1_MSK 0x01

#define AM1805_CONTROL1_1224_MSK 0x40
#define AM1805_CONTROL1_RSP_MSK 0x08
#define AM1805_CONTROL1_ARST_MSK 0x04
#define AM1805_CONTROL1_PWR2_MSK 0x02
#define AM1805_CONTROL1_WRTC_MSK 0x01

#define AM1805_CONTROL2_RS1E_MSK 0x20
#define AM1805_CONTROL2_OUT2S_MSK 0x1C
#define AM1805_CONTROL2_OUT1S_MSK 0x03

#define AM1805_INTERRUPT_CEB_MSK 0x80
#define AM1805_INTERRUPT_IM_MSK 0x60
#define AM1805_INTERRUPT_BLIE_MSK 0x10
#define AM1805_INTERRUPT_TIE_MSK 0x08
#define AM1805_INTERRUPT_AIE_MSK 0x04
#define AM1805_INTERRUPT_EX2E_MSK 0x02
#define AM1805_INTERRUPT_EX1E_MSK 0x01

#define AM1805_SLEEP_CONTROL_SLP_MSK 0x80
#define AM1805_SLEEP_CONTROL_SLRES_MSK 0x40
#define AM1805_SLEEP_CONTROL_EX2P_MSK 0x20
#define AM1805_SLEEP_CONTROL_EX1P_MSK 0x10
#define AM1805_SLEEP_CONTROL_SLST_MSK 0x08
#define AM1805_SLEEP_CONTROL_SLTO_MSK 0x07

#define AM1805_TIMER_CONTROL_TE_MSK 0x80
#define AM1805_TIMER_CONTROL_TM_MSK 0x40
#define AM1805_TIMER_CONTROL_TRPT_MSK 0x20
#define AM1805_TIMER_CONTROL_RPT_MSK 0x1C
#define AM1805_TIMER_CONTROL_TFS_MSK 0x03

#define AM1805_OCTRL_WDBM_MSK 0x80
#define AM1805_OCTRL_EXBM_MSK 0x40
#define AM1805_OCTRL_WDDS_MSK 0x20
#define AM1805_OCTRL_EXDS_MSK 0x10
#define AM1805_OCTRL_RSEN_MSK 0x08
#define AM1805_OCTRL_O4EN_MSK 0x04
#define AM1805_OCTRL_O3EN_MSK 0x02
#define AM1805_OCTRL_O1EN_MSK 0x01

#define AM1805_OSC_CONTROL_OSEL_MSK 0x80
#define AM1805_OSC_CONTROL_ACAL_MSK 0x60
#define AM1805_OSC_CONTROL_AOS_MSK 0x10
#define AM1805_OSC_CONTROL_FOS_MSK 0x08
#define AM1805_OSC_CONTROL_PWGT_MSK 0x04
#define AM1805_OSC_CONTROL_OFIE_MSK 0x02
#define AM1805_OSC_CONTROL_ACIE_MSK 0x01

#define AM1805_WDT_REG_WDS_MSK 0x80
#define AM1805_WDT_REG_BMB_MSK 0x7C
#define AM1805_WDT_REG_WRB_MSK 0x03

#define AM1805_WDT_REG_WDS_SHIFT (7)
#define AM1805_WDT_REG_BMB_SHIFT (2)
#define AM1805_WDT_REG_WRB_SHIFT (0)

#define AM1805_WDT_REG_WRB_QUARTER_HZ (0x03)
#define AM1805_WDT_REG_WRB_ONE_HZ (0x02)
#define AM1805_WDT_REG_WRB_FOUR_HZ (0x01)
#define AM1805_WDT_REG_WRB_SIXTEEN_HZ (0x00)

#define AM1805_CONFIG_KEY_OSCILLATOR (0xA1)
#define AM1805_CONFIG_KEY_RESET (0x3C)
#define AM1805_CONFIG_KEY_OTHERS (0x9D)

#define AM1805_TRICKLE_REG_TCS_VAL (0xA)
#define AM1805_TRICKLE_REG_TCS_OFFSET (4UL)
#define AM1805_TRICKLE_REG_TCS_MSK (AM1805_TRICKLE_REG_TCS_VAL << AM1805_TRICKLE_REG_TCS_OFFSET)

#define AM1805_TRICKLE_REG_DIODE_SCHOTTKY_VAL (0x1)
#define AM1805_TRICKLE_REG_DIODE_STANDARD_VAL (0x2)
#define AM1805_TRICKLE_REG_DIODE_OFFSET (2UL)
#define AM1805_TRICKLE_REG_DIODE_SCHOTTKY_MSK (AM1805_TRICKLE_REG_DIODE_SCHOTTKY_VAL << AM1805_TRICKLE_REG_DIODE_OFFSET)

#define AM1805_TRICKLE_REG_ROUT_DISABLE_VAL (0x0)
#define AM1805_TRICKLE_REG_ROUT_3K_VAL (0x1)
#define AM1805_TRICKLE_REG_ROUT_6K_VAL (0x2)
#define AM1805_TRICKLE_REG_ROUT_11K_VAL (0x3)

#define AM1805_TRICKLE_REG_ROUT_OFFSET (0UL)
#define AM1805_TRICKLE_REG_ROUT_DISABLE_MSK (AM1805_TRICKLE_REG_ROUT_DISABLE_VAL << AM1805_TRICKLE_REG_ROUT_OFFSET)
#define AM1805_TRICKLE_REG_ROUT_3K_MSK (AM1805_TRICKLE_REG_ROUT_3K_VAL << AM1805_TRICKLE_REG_ROUT_OFFSET)
#define AM1805_TRICKLE_REG_ROUT_6K_MSK (AM1805_TRICKLE_REG_ROUT_6K_VAL << AM1805_TRICKLE_REG_ROUT_OFFSET)
#define AM1805_TRICKLE_REG_ROUT_11K_MSK (AM1805_TRICKLE_REG_ROUT_11K_VAL << AM1805_TRICKLE_REG_ROUT_OFFSET)

#define AM1805_TIMER_CTRL_RPT_YEAR_VAL (0x1)
#define AM1805_TIMER_CTRL_RPT_DAY_VAL (0x4)
#define AM1805_TIMER_CTRL_RPT_OFFSET (2UL)
#define AM1805_TIMER_CTRL_RPT_YEAR_MSK (AM1805_TIMER_CTRL_RPT_YEAR_VAL << AM1805_TIMER_CTRL_RPT_OFFSET)
#define AM1805_TIMER_CTRL_RPT_DAY_MSK (AM1805_TIMER_CTRL_RPT_DAY_VAL << AM1805_TIMER_CTRL_RPT_OFFSET)

#define AM1805_CONTROL2_OUT2S_OFFSET (2UL)
#define AM1805_CONTROL2_OUT2S_SLEEP_VAL (6)
#define AM1805_CONTROL2_OUT2S_SLEEP_MSK (AM1805_CONTROL2_OUT2S_SLEEP_VAL << AM1805_CONTROL2_OUT2S_OFFSET)

typedef enum {
  AM1805_ALARM_REPEAT_DISABLE = 0,
  AM1805_ALARM_REPEAT_YEAR = 1,
  AM1805_ALARM_REPEAT_MONTH = 2,
  AM1805_ALARM_REPEAT_WEEK = 3,
  AM1805_ALARM_REPEAT_DAY = 4,
  AM1805_ALARM_REPEAT_HOUR = 5,
  AM1805_ALARM_REPEAT_MINUTE = 6,
} am1805_alarm_repeat_t;

typedef struct {
  uint8_t repeat;
  uint8_t month;
  uint8_t weekday;
  uint8_t date;
  uint8_t hour;
  uint8_t minute;
  uint8_t second;
} am1805_alarm_t;

/* Establishes connection to device. Can block for multiple seconds! */
int riotee_am1805_init(void);

int riotee_am1805_get_hundredths(unsigned int* hundredths);
int riotee_am1805_set_datetime(struct tm* t);
int riotee_am1805_get_datetime(struct tm* t);

int riotee_am1805_set_alarm(struct tm* t_alarm);
int riotee_am1805_get_alarm(struct tm* t);
int riotee_am1805_get_status(uint8_t* dst);
int riotee_am1805_reset(void);

/* Cuts power supply to all devices except AM1805 */
int riotee_am1805_disable_power(void);

/* Enables trickle charging of VBAT from VCC */
int riotee_am1805_enable_trickle(void);

/* Reads device ID. Should always return 0x0518. */
int riotee_am1805_get_id(uint16_t* id);

/* Clear flag for alarm interrupt in status register. */
int riotee_am1805_clear_alarm();

#endif /* __RIOTEE_AM1805_H_ */